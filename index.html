<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dark Chat Overlay v1.1.1 mit Audio, Screen & Datei-Upload</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #121214;
      --surface: #1c1c1e;
      --header: #1f1f1f;
      --accent: #007aff;
      --success: #28a745;
      --text: #e5e5ea;
      --muted: #8e8e93;
      --radius: 8px;
      --shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; scroll-behavior: smooth; }
    body.with-notice .header { margin-top: 40px; }
    .header { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; padding: 10px; background: var(--header); box-shadow: var(--shadow); }
    .header button, .header select, .header label, .header input { height: 36px; padding: 0 12px; background: #242426; border: 1px solid #333; border-radius: var(--radius); color: var(--text); cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px; white-space: nowrap; }
    .header input[type="text"] { width: 150px; }
    .spacer { flex: 1; }
    #chatBody { flex: 1; overflow-y: auto; padding: 16px; display: none; flex-direction: column; gap: 10px; transition: all 0.3s ease; }
    .chat-input { display: none; padding: 12px; background: var(--surface); border-top: 1px solid #333; transition: all 0.3s ease; }
    .chat-input textarea { width: 100%; height: 60px; padding: 10px; border: 1px solid #333; border-radius: var(--radius); background: #242426; color: var(--text); resize: none; font-size: 14px; }
    .message { padding: 10px 14px; border-radius: var(--radius); max-width: 70%; word-break: break-word; box-shadow: var(--shadow); position: relative; }
    .user { background: linear-gradient(to right, var(--accent), #0051b0); color: #fff; align-self: flex-end; border-bottom-right-radius: 0; }
    .assistant { background: linear-gradient(to right, #2c2c2c, #1a1a1a); align-self: flex-start; border-bottom-left-radius: 0; }
    .timestamp { font-size: 12px; color: var(--muted); text-align: right; margin-top: 4px; }
    #remoteScreen { position: fixed; bottom: 12px; right: 12px; width: 320px; height: 180px; display: none; border: 2px solid var(--accent); border-radius: var(--radius); box-shadow: var(--shadow); background: black; object-fit: contain; z-index: 10; }
    #remoteScreen:fullscreen { width: 100vw; height: 100vh; }
    #fullscreenBtn { position: fixed; bottom: 200px; right: 12px; background: var(--accent); color: #fff; border: none; border-radius: var(--radius); padding: 6px 12px; cursor: pointer; display: none; z-index: 999; }
    #screenNotice { display: none; position: fixed; top: 0; left: 0; width: 100%; background: var(--success); color: white; padding: 10px 16px; text-align: center; font-weight: 600; font-size: 15px; z-index: 9999; box-shadow: 0 2px 8px rgba(0,0,0,0.3); animation: slideDown 0.3s ease-out; }
    @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    audio { display: none; } a { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>
  <div id="screenNotice" role="status" aria-live="polite">üü¢ Bildschirm wird geteilt</div>
  <div class="header">
    <span style="margin-right:8px; color:var(--muted);">v1.1.1</span>
    <input id="usernameInput" type="text" placeholder="Benutzername" aria-label="Benutzername">
    <button id="connectBtn" aria-label="Verbinden">üîå Verbinden</button>
    <select id="micSelect" title="Mikrofon" aria-label="Mikrofon ausw√§hlen"><option value="">Standardger√§t</option></select>
    <select id="qualitySelect" title="Qualit√§t" aria-label="Qualit√§t ausw√§hlen">
      <option value="1280x720">HD (720p)</option>
      <option value="1920x1080">Full HD (1080p)</option>
      <option value="2560x1440" selected>2K (1440p)</option>
      <option value="3840x2160">4K (2160p)</option>
    </select>
    <button id="screenBtn" aria-label="Bildschirm teilen" disabled>üñ•Ô∏è Teilen</button>
    <label id="uploadBtn" title="Dateien hochladen" aria-label="Dateien hochladen">üìÅ Hochladen<input id="fileInput" type="file" multiple style="display: none;"></label>
    <button id="clearBtn" aria-label="Chat leeren">üóëÔ∏è Leeren</button>
    <div class="spacer"></div>
    <div id="userList" style="padding: 8px; font-size: 0.85rem; color: var(--muted);"></div>
  </div>

  <div id="chatBody"></div>
  <div class="chat-input"><textarea id="messageInput" placeholder="Nachricht schreiben..." aria-label="Nachachricht schreiben"></textarea></div>
  <video id="remoteScreen" autoplay playsinline></video>
  <button id="fullscreenBtn" aria-label="Vollbild anzeigen">üîé Vollbild</button>
  <audio id="remoteAudio" autoplay></audio>

  <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
  <script>
    const APP_VERSION = '1.1.1'; document.querySelector('.header span').textContent = APP_VERSION;
    const socket = io('/', { autoConnect: false, reconnection: true });
    let connected=false, peer=null, localStream=null, remoteStream=null; const pendingIce=[];
    const usernameInput=document.getElementById('usernameInput'), connectBtn=document.getElementById('connectBtn'), chat=document.getElementById('chatBody'), inputArea=document.querySelector('.chat-input'), msg=document.getElementById('messageInput'), clear=document.getElementById('clearBtn'), screenBtn=document.getElementById('screenBtn'), video=document.getElementById('remoteScreen'), micSelect=document.getElementById('micSelect'), qualitySelect=document.getElementById('qualitySelect'), fullscreenBtn=document.getElementById('fullscreenBtn'), remoteAudio=document.getElementById('remoteAudio'), fileInput=document.getElementById('fileInput'), screenNotice=document.getElementById('screenNotice'), userList=document.getElementById('userList');
    usernameInput.value=localStorage.getItem('username')||''; usernameInput.onchange=()=>localStorage.setItem('username',usernameInput.value.trim());
    micSelect.value=localStorage.getItem('micId')||''; qualitySelect.value=localStorage.getItem('quality')||'2560x1440';
    async function loadMicrophones(){try{const s=await navigator.mediaDevices.getUserMedia({audio:true});s.getTracks().forEach(t=>t.stop());const d=await navigator.mediaDevices.enumerateDevices();micSelect.innerHTML='<option value="">Standardger√§t</option>';d.filter(x=>x.kind==='audioinput').forEach((x,i)=>{const o=document.createElement('option');o.value=x.deviceId;o.text=x.label||`Mikrofon ${i+1}`;micSelect.appendChild(o)});micSelect.value=localStorage.getItem('micId')||'';}catch(e){console.warn('Keine Mikrofone',e);}} loadMicrophones();micSelect.onchange=()=>localStorage.setItem('micId',micSelect.value);qualitySelect.onchange=()=>localStorage.setItem('quality',qualitySelect.value);
    function initPeer(){ if(peer){peer.close();peer=null;} peer=new RTCPeerConnection(); remoteStream=new MediaStream(); video.srcObject=remoteStream; remoteAudio.srcObject=remoteStream; peer.ontrack=e=>{e.streams[0].getTracks().forEach(t=>{if(!remoteStream.getTracks().some(r=>r.id===t.id))remoteStream.addTrack(t)});video.style.display='block';fullscreenBtn.style.display='block';}; peer.onicecandidate=e=>{if(e.candidate)socket.emit('ice',{candidate:e.candidate,room:'default'});}; pendingIce.forEach(c=>peer.addIceCandidate(c).catch(console.warn));pendingIce.length=0; peer.onnegotiationneeded=async()=>{try{const offer=await peer.createOffer();await peer.setLocalDescription(offer);socket.emit('offer',{offer,room:'default',username:usernameInput.value.trim()});}catch(err){console.error('Reneg-Verh:',err);}}; }

    socket.on('offer',async d=>{try{initPeer();localStream=await getAudioStream();localStream.getAudioTracks().forEach(t=>peer.addTrack(t,localStream));await peer.setRemoteDescription(new RTCSessionDescription(d.offer));const ans=await peer.createAnswer();await peer.setLocalDescription(ans);socket.emit('answer',{answer:ans,room:'default',username:usernameInput.value.trim()});}catch(e){console.error(e);}});
    socket.on('answer',async d=>{try{await peer.setRemoteDescription(new RTCSessionDescription(d.answer));}catch(e){console.error(e);}});
    socket.on('ice',async d=>{if(d.candidate){if(!peer)pendingIce.push(d.candidate);else try{await peer.addIceCandidate(d.candidate);}catch(e){console.error(e);}}});

    // Bei User-List Update: UI und Neuverhandlung
    socket.on('users',async users=>{
      userList.innerHTML='üßë‚Äçü§ù‚Äçüßë Verbundene IPs:<br>'+users.map(u=>`‚Ä¢ ${u}`).join('<br>');
      // Neu verhandeln, um neue Clients zu erreichen
      if(connected && peer){
        try{
          const offer=await peer.createOffer();
          await peer.setLocalDescription(offer);
          socket.emit('offer',{offer,room:'default',username:usernameInput.value.trim()});
        }catch(err){console.error('Rerend-Verh:',err);}
      }
    });

    async function getAudioStream(){try{return await navigator.mediaDevices.getUserMedia({audio:micSelect.value?{deviceId:{exact:micSelect.value}}:true});}catch{return await navigator.mediaDevices.getUserMedia({audio:true});}}

    connectBtn.onclick=async()=>{connected=!connected;if(connected){connectBtn.style.background='green';chat.style.display='flex';inputArea.style.display='block';socket.connect();socket.emit('join','default',usernameInput.value.trim());socket.emit('get_users','default');initPeer();try{localStream=await getAudioStream();localStream.getAudioTracks().forEach(t=>peer.addTrack(t,localStream));}catch(e){console.error(e);alert('Mikrofon-Fehler');}screenBtn.disabled=false;}else{connectBtn.style.background='red';chat.style.display='none';inputArea.style.display='none';socket.disconnect();if(peer){peer.close();peer=null;}if(localStream){localStream.getTracks().forEach(t=>t.stop());localStream=null;}screenNotice.style.display='none';document.body.classList.remove('with-notice');screenBtn.disabled=true;pendingIce.length=0;}};
    screenBtn.onclick=async()=>{try{const [w,h]=qualitySelect.value.split('x').map(Number);const s=await navigator.mediaDevices.getDisplayMedia({video:{width:{ideal:w},height:{ideal:h},frameRate:{ideal:30}}});s.getTracks().forEach(t=>peer.addTrack(t,s));screenNotice.style.display='block';document.body.classList.add('with-notice');s.getVideoTracks()[0].addEventListener('ended',()=>{screenNotice.style.display='none';document.body.classList.remove('with-notice');});}catch(e){console.warn('Share abgebrochen',e);}};
    msg.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();if(!msg.value.trim())return;const user=usernameInput.value.trim()||'User';socket.emit('message',{room:'default',user,text:msg.value});appendMsg(user,msg.value,'user');msg.value='';}});
    socket.on('message',d=>appendMsg(d.user,d.text,'assistant'));
    clear.onclick=()=>{chat.innerHTML='';};
    fileInput.addEventListener('change',async()=>{const files=Array.from(fileInput.files);if(!files.length)return;const fd=new FormData();files.forEach(f=>fd.append('files',f));try{const r=await fetch('/upload',{method:'POST',body:fd});if(!r.ok)throw new Error(r.statusText);const res=await r.json();res.files.forEach(f=>appendMsg(usernameInput.value.trim()||'User',`üìé <a href="${f.url}" target="_blank">${f.name}</a>`,'user'));}catch(e){alert('Upload fehlgeschlagen');console.error(e);}finally{fileInput.value='';}});
    function appendMsg(name,text,type){const t=new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});chat.innerHTML+=`<div class="message ${type}"><strong>${name}:</strong> ${text}<div class="timestamp">${t}</div></div>`;chat.scrollTop=chat.scrollHeight;}
  </script>
</body>
</html>
