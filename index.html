<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dark Chat Overlay v1.2.0 mit Multi-Peer-UnterstÃ¼tzung</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#121214; --surface:#1c1c1e; --header:#1f1f1f; --accent:#007aff; --success:#28a745; --text:#e5e5ea; --muted:#8e8e93; --radius:8px; --shadow:0 4px 12px rgba(0,0,0,0.5); }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; flex-direction:column; scroll-behavior:smooth; }
    body.with-notice .header { margin-top:40px; }
    .header { display:flex; flex-wrap:wrap; align-items:center; gap:8px; padding:10px; background:var(--header); box-shadow:var(--shadow); }
    .header button, .header select, .header label, .header input { height:36px; padding:0 12px; background:#242426; border:1px solid #333; border-radius:var(--radius); color:var(--text); cursor:pointer; font-size:14px; display:flex; align-items:center; gap:6px; white-space:nowrap; }
    .header input[type="text"] { width:150px; }
    .spacer { flex:1; }
    #chatBody { flex:1; overflow-y:auto; padding:16px; display:none; flex-direction:column; gap:10px; transition:all .3s ease; }
    .chat-input { display:none; padding:12px; background:var(--surface); border-top:1px solid #333; transition:all .3s ease; }
    .chat-input textarea { width:100%; height:60px; padding:10px; border:1px solid #333; border-radius:var(--radius); background:#242426; color:var(--text); resize:none; font-size:14px; }
    .message { padding:10px 14px; border-radius:var(--radius); max-width:70%; word-break:break-word; box-shadow:var(--shadow); position:relative; }
    .user { background:linear-gradient(to right,var(--accent),#0051b0); color:#fff; align-self:flex-end; border-bottom-right-radius:0; }
    .assistant { background:linear-gradient(to right,#2c2c2c,#1a1a1a); align-self:flex-start; border-bottom-left-radius:0; }
    .timestamp { font-size:12px; color:var(--muted); text-align:right; margin-top:4px; }
    #screenNotice { display:none; position:fixed; top:0; left:0; width:100%; background:var(--success); color:white; padding:10px 16px; text-align:center; font-weight:600; font-size:15px; z-index:9999; box-shadow:0 2px 8px rgba(0,0,0,0.3); animation:slideDown .3s ease-out; }
    @keyframes slideDown { from { transform:translateY(-100%); opacity:0; } to { transform:translateY(0); opacity:1; } }
    video.remote { position:fixed; bottom:12px; right:12px; width:200px; height:120px; border:2px solid var(--accent); border-radius:var(--radius); box-shadow:var(--shadow); object-fit:contain; z-index:10; margin:4px; }
    #fullscreenBtn { position:fixed; bottom:200px; right:12px; background:var(--accent); color:#fff; border:none; border-radius:var(--radius); padding:6px 12px; cursor:pointer; display:none; z-index:999; }
    a { color:var(--accent); text-decoration:none; }
  </style>
</head>
<body>
  <div id="screenNotice" role="status" aria-live="polite">ğŸŸ¢ Bildschirm wird geteilt</div>
  <div class="header">
    <span style="margin-right:8px;color:var(--muted);">v1.2.0</span>
    <input id="usernameInput" type="text" placeholder="Benutzername" aria-label="Benutzername">
    <button id="connectBtn" aria-label="Verbinden">ğŸ”Œ Verbinden</button>
    <select id="micSelect" aria-label="Mikrofon auswÃ¤hlen"><option value="">StandardgerÃ¤t</option></select>
    <select id="qualitySelect" aria-label="QualitÃ¤t auswÃ¤hlen">
      <option value="1280x720">HD (720p)</option>
      <option value="1920x1080">Full HD (1080p)</option>
      <option value="2560x1440" selected>2K (1440p)</option>
      <option value="3840x2160">4K (2160p)</option>
    </select>
    <button id="screenBtn" aria-label="Bildschirm teilen" disabled>ğŸ–¥ï¸ Teilen</button>
    <label id="uploadBtn" aria-label="Dateien hochladen">ğŸ“ Hochladen<input id="fileInput" type="file" multiple style="display:none"></label>
    <button id="clearBtn" aria-label="Chat leeren">ğŸ—‘ï¸ Leeren</button>
    <div class="spacer"></div>
    <div id="userList" style="padding:8px;font-size:0.85rem;color:var(--muted)"></div>
  </div>
  <div id="chatBody"></div>
  <div class="chat-input"><textarea id="messageInput" placeholder="Nachricht schreiben..." aria-label="Nachachricht schreiben"></textarea></div>
  <button id="fullscreenBtn" aria-label="Vollbild anzeigen">ğŸ” Vollbild</button>

  <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
  <script>
    const APP_VERSION = '1.2.0';
    document.querySelector('.header span').textContent = APP_VERSION;
    const socket = io('/', { autoConnect:false, reconnection:true });
    const peers = {};
    let localStream=null, username='';
    const usernameInput=document.getElementById('usernameInput'), connectBtn=document.getElementById('connectBtn'), micSelect=document.getElementById('micSelect'), qualitySelect=document.getElementById('qualitySelect'), screenBtn=document.getElementById('screenBtn'), chatBody=document.getElementById('chatBody'), inputArea=document.querySelector('.chat-input'), msgInput=document.getElementById('messageInput'), clearBtn=document.getElementById('clearBtn'), fileInput=document.getElementById('fileInput'), screenNotice=document.getElementById('screenNotice'), userList=document.getElementById('userList');
    // Persistenz
    usernameInput.value=localStorage.getItem('username')||'';
    usernameInput.onchange=()=>localStorage.setItem('username',usernameInput.value.trim());
    micSelect.value=localStorage.getItem('micId')||'';
    qualitySelect.value=localStorage.getItem('quality')||'2560x1440';
    micSelect.onchange=()=>localStorage.setItem('micId',micSelect.value);
    qualitySelect.onchange=()=>localStorage.setItem('quality',qualitySelect.value);
    // Load mics
    async function loadMicrophones(){try{const s=await navigator.mediaDevices.getUserMedia({audio:true});s.getTracks().forEach(t=>t.stop());const d=await navigator.mediaDevices.enumerateDevices();micSelect.innerHTML='<option value="">StandardgerÃ¤t</option>';d.filter(x=>x.kind==='audioinput').forEach((x,i)=>{const o=document.createElement('option');o.value=x.deviceId; o.text=x.label||`Mikrofon ${i+1}`;micSelect.appendChild(o)});micSelect.value=localStorage.getItem('micId')||'';}catch(e){console.warn('Mikrofone nicht verfÃ¼gbar',e);}} loadMicrophones();
    async function getAudioStream(){try{return await navigator.mediaDevices.getUserMedia({audio:micSelect.value?{deviceId:{exact:micSelect.value}}:true});}catch{return await navigator.mediaDevices.getUserMedia({audio:true});}}
    function createPeerConnection(peerId,isInitiator){const pc=new RTCPeerConnection();pc.onicecandidate=e=>{if(e.candidate)socket.emit('ice',{to:peerId,candidate:e.candidate})};pc.ontrack=e=>{const stream=e.streams[0];let vid=document.getElementById(`video-${peerId}`);if(!vid){vid=document.createElement('video');vid.id=`video-${peerId}`;vid.className='remote';vid.autoplay=true;vid.playsInline=true;document.body.appendChild(vid);} vid.srcObject=stream;};if(localStream) localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));if(isInitiator){pc.onnegotiationneeded=async()=>{const offer=await pc.createOffer();await pc.setLocalDescription(offer);socket.emit('offer',{to:peerId,sdp:pc.localDescription});};}return pc;}
    socket.on('users',list=>{userList.innerHTML='ğŸ§‘â€ğŸ¤â€ğŸ§‘ Verbundene:<br>'+list.map(u=>`â€¢ ${u}`).join('<br>');list.forEach(id=>{if(id===socket.id)return; if(!peers[id]) peers[id]=createPeerConnection(id,true);});});
    socket.on('offer',async d=>{const{from,sdp}=d;if(!peers[from])peers[from]=createPeerConnection(from,false);const pc=peers[from];await pc.setRemoteDescription(new RTCSessionDescription(sdp));const ans=await pc.createAnswer();await pc.setLocalDescription(ans);socket.emit('answer',{to:from,sdp:pc.localDescription});});
    socket.on('answer',async d=>{const{from,sdp}=d;const pc=peers[from];if(pc) await pc.setRemoteDescription(new RTCSessionDescription(sdp));});
    socket.on('ice',async d=>{const{from,candidate}=d;const pc=peers[from];if(pc) await pc.addIceCandidate(new RTCIceCandidate(candidate));});
    // Screen share
    screenBtn.onclick=async()=>{try{const [w,h]=qualitySelect.value.split('x').map(Number);const ss=await navigator.mediaDevices.getDisplayMedia({video:{width:{ideal:w},height:{ideal:h},frameRate:{ideal:30}}});ss.getVideoTracks().forEach(t=>{for(let id in peers) peers[id].addTrack(t,ss)});screenNotice.style.display='block';document.body.classList.add('with-notice');ss.getVideoTracks()[0].addEventListener('ended',()=>{screenNotice.style.display='none';document.body.classList.remove('with-notice');});}catch(e){console.warn('Share abgebrochen',e);}};
    // Chat handlers
    msgInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();if(!msgInput.value.trim())return;const user=usernameInput.value.trim()||'User';socket.emit('message',{room:'default',user,text:msgInput.value});appendMsg(user,msgInput.value,'user');msgInput.value='';}});
    socket.on('message',d=>appendMsg(d.user,d.text,'assistant'));
    function appendMsg(name,text,type){const t=new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});const el=document.createElement('div');el.className=`message ${type}`;el.innerHTML=`<strong>${name}:</strong> ${text}<div class="timestamp">${t}</div>`;chatBody.appendChild(el);chatBody.scrollTop=chatBody.scrollHeight;}
    clearBtn.onclick=()=>{chatBody.innerHTML='';};
    // File upload
    fileInput.addEventListener('change',async()=>{const files=Array.from(fileInput.files);if(!files.length) return;const fd=new FormData();files.forEach(f=>fd.append('files',f));try{const res=await fetch('/upload',{method:'POST',body:fd});if(!res.ok) throw new Error(res.statusText);const data=await res.json();data.files.forEach(f=>appendMsg(usernameInput.value.trim()||'User',`ğŸ“ <a href="${f.url}" target="_blank">${f.name}</a>`,'user'));}catch(e){alert('Upload fehlgeschlagen!');console.error(e);}finally{fileInput.value='';}});
    // Connect
    connectBtn.onclick=async()=>{if(!socket.connected){username=usernameInput.value.trim()||'User';localStream=await getAudioStream();localStream.getAudioTracks().forEach(t=>t.enabled=true);socket.auth={username};socket.connect();socket.emit('join-room','default');chatBody.style.display='flex';inputArea.style.display='block';screenBtn.disabled=false;connectBtn.textContent='ğŸ”Œ Trennen';}else{Object.values(peers).forEach(pc=>pc.close());for(let k in peers) delete peers[k];if(localStream) localStream.getTracks().forEach(t=>t.stop());socket.disconnect();chatBody.style.display='none';inputArea.style.display='none';screenBtn.disabled=true;connectBtn.textContent='ğŸ”Œ Verbinden';}};
  </script>
</body>
</html>
